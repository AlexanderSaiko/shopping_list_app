<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</title>
    <style>
        :root {
            --background: #f2f2f7;
            --card-background: #ffffff;
            --text: #000000;
            --secondary-text: #6e6e73;
            --accent: #007aff;
            --button-background: #007aff;
            --button-text: #ffffff;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --border: #d1d1d6;
            --completed: #ff0000;
        }

        [data-theme="dark"] {
            --background: #1c1c1e;
            --card-background: #2c2c2e;
            --text: #ffffff;
            --secondary-text: #8e8e93;
            --accent: #0a84ff;
            --button-background: #0a84ff;
            --button-text: #ffffff;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            --border: #3c3c3e;
            --completed: #ff6666;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', sans-serif;
            background: var(--background);
            color: var(--text);
            transition: all 0.3s ease;
            overflow-x: hidden;
        }

        header {
            background: var(--card-background);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header h1 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text);
        }

        nav {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #navMenu {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        nav button {
            background: none;
            border: none;
            color: var(--secondary-text);
            font-size: 16px;
            padding: 8px 12px;
            cursor: pointer;
            transition: color 0.3s ease;
            min-height: 44px;
            position: relative;
        }

        nav button::before {
            content: attr(data-icon);
            font-size: 18px;
            margin-right: 8px;
            vertical-align: middle;
        }

        nav button.active, nav button:hover {
            color: var(--accent);
        }

        .theme-toggle {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--secondary-text);
            min-height: 44px;
            min-width: 44px;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle::before {
            content: 'üåô';
            font-size: 20px;
            margin: 0;
        }

        .menu-toggle {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--secondary-text);
            min-height: 44px;
            min-width: 44px;
            display: none;
        }

        .auth-info {
            color: var(--secondary-text);
            font-size: 14px;
            margin-left: 8px;
        }

        .container {
            max-width: 1200px;
            margin: 16px auto;
            padding: 0 16px;
        }

        .tab {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text);
        }

        select, input[type="text"], input[type="number"], input[type="password"] {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            background: var(--card-background);
            color: var(--text);
            appearance: none;
            transition: border-color 0.3s ease;
            min-height: 44px;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--accent);
        }

        button {
            background: var(--button-background);
            color: var(--button-text);
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s ease;
            margin: 8px 4px;
            display: inline-block;
            min-height: 44px;
            min-width: 44px;
        }

        button:hover {
            background: var(--accent);
            filter: brightness(1.1);
        }

        button.secondary {
            background: var(--card-background);
            color: var(--accent);
            border: 1px solid var(--border);
        }

        ul {
            list-style: none;
            padding: 0;
        }

        ul li {
            background: var(--card-background);
            padding: 12px;
            margin: 8px 0;
            border-radius: 10px;
            font-size: 16px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            box-shadow: var(--shadow);
            transition: transform 0.2s ease;
        }

        ul li:hover {
            transform: translateY(-2px);
        }

        ul li.completed {
            text-decoration: line-through;
            text-decoration-color: var(--completed);
            color: var(--secondary-text);
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .quantity-controls button {
            background: var(--card-background);
            color: var(--accent);
            padding: 8px;
            font-size: 14px;
            margin: 0;
            border: 1px solid var(--border);
            min-height: 44px;
        }

        .quantity-controls input {
            width: 50px;
            max-width: 50px;
            text-align: center;
            margin: 0;
            min-height: 44px;
        }

        .comment-input, .price-input {
            flex-grow: 1;
            max-width: 200px;
            min-height: 44px;
        }

        #suggestions {
            position: absolute;
            background: var(--card-background);
            border: 1px solid var(--border);
            max-height: 150px;
            overflow-y: auto;
            z-index: 10;
            width: 100%;
            max-width: 300px;
            border-radius: 10px;
            box-shadow: var(--shadow);
        }

        #suggestions div {
            padding: 12px;
            cursor: pointer;
            color: var(--text);
            min-height: 44px;
        }

        #suggestions div:hover {
            background: var(--background);
        }

        .list-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .list-controls select {
            max-width: 200px;
        }

        .list-controls button {
            padding: 8px 12px;
            font-size: 14px;
            min-height: 44px;
        }

        .edit-delete-controls {
            display: flex;
            gap: 4px;
            margin-left: auto;
        }

        .edit-delete-controls button {
            padding: 8px;
            font-size: 14px;
            min-height: 44px;
        }

        .total-sum {
            font-size: 18px;
            font-weight: 600;
            margin-top: 16px;
            color: var(--text);
            text-align: right;
        }

        .lists-tab-content {
            display: flex;
            gap: 16px;
        }

        .lists-main {
            flex: 1;
            max-width: 600px;
        }

        #selectedItemsColumn {
            width: 300px;
            background: var(--card-background);
            border-left: 1px solid var(--border);
            padding: 16px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            display: none;
        }

        #selectedItemsColumn.active {
            display: block;
        }

        #selectedItemsColumn h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text);
        }

        #toggleSelectedItems {
            display: none;
            margin: 8px 0;
        }

        .mobile-item-controls {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-left: auto;
        }

        .mobile-item-controls button {
            background: none;
            border: none;
            color: var(--accent);
            font-size: 16px;
            padding: 4px;
            min-height: 32px;
            min-width: 32px;
        }

        .quantity-display {
            cursor: pointer;
            padding: 4px 8px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            min-width: 40px;
            text-align: center;
        }

        .mobile-input {
            display: none;
            width: 100px;
            padding: 4px;
            font-size: 14px;
            min-height: 32px;
        }

        @media (max-width: 430px) {
            body {
                font-size: 14px;
            }

            header {
                flex-direction: row;
                align-items: center;
                padding: 8px 12px;
                height: 50px;
            }

            header h1 {
                font-size: 18px;
            }

            nav {
                position: relative;
                width: auto;
            }

            #navMenu {
                display: none;
                flex-direction: row;
                flex-wrap: wrap;
                gap: 4px;
                position: absolute;
                top: 50px;
                left: 0;
                right: 0;
                width: 100%;
                background: var(--card-background);
                border: 1px solid var(--border);
                border-radius: 0 0 10px 10px;
                box-shadow: var(--shadow);
                padding: 4px;
                z-index: 99;
                animation: slideDown 0.3s ease;
                overflow-y: auto;
            }

            #navMenu.open {
                display: flex;
            }

            @keyframes slideDown {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }

            nav button, .theme-toggle {
                width: 44px;
                height: 44px;
                padding: 8px;
                min-height: 44px;
                min-width: 44px;
                display: flex;
                justify-content: center;
                align-items: center;
                text-align: center;
            }

            nav button::before {
                margin-right: 0;
                font-size: 20px;
            }

            nav button .text {
                display: none;
            }

            .auth-info {
                display: none;
            }

            .menu-toggle {
                display: block;
            }

            .container {
                margin: 8px;
                padding: 0 8px;
            }

            h2 {
                font-size: 20px;
            }

            select, input[type="text"], input[type="number"], input[type="password"] {
                max-width: 100%;
                min-height: 44px;
                font-size: 14px;
            }

            button {
                width: 100%;
                padding: 12px;
                min-height: 44px;
            }

            ul li {
                flex-direction: row;
                align-items: center;
                padding: 8px;
                margin: 4px 0;
                font-size: 14px;
                border: 1px solid var(--border);
                box-shadow: none;
                min-height: 44px;
            }

            .quantity-controls {
                display: none;
            }

            .comment-input, .price-input {
                display: none;
            }

            .list-controls {
                flex-direction: column;
                align-items: flex-start;
            }

            .list-controls select {
                max-width: 100%;
            }

            .total-sum {
                text-align: left;
                font-size: 16px;
            }

            .lists-tab-content {
                flex-direction: column;
            }

            #selectedItemsColumn {
                width: 100%;
                border-left: none;
                border-top: 1px solid var(--border);
                display: none;
            }

            #selectedItemsColumn.active {
                display: block;
            }

            #toggleSelectedItems {
                display: block;
                width: auto;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</h1>
        <nav>
            <button id="menuToggle" class="menu-toggle">‚ò∞</button>
            <div id="navMenu">
                <button id="shopTabBtn" class="active" data-icon="üõí" aria-label="–û—Ç–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥–∫—É –í –º–∞–≥–∞–∑–∏–Ω–µ">
                    <span class="text">–í –º–∞–≥–∞–∑–∏–Ω–µ</span>
                </button>
                <button id="listsTabBtn" data-icon="üìã" aria-label="–û—Ç–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥–∫—É –°–ø–∏—Å–∫–∏">
                    <span class="text">–°–ø–∏—Å–∫–∏</span>
                </button>
                <button id="productsTabBtn" data-icon="ü•ï" aria-label="–û—Ç–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥–∫—É –ü—Ä–æ–¥—É–∫—Ç—ã">
                    <span class="text">–ü—Ä–æ–¥—É–∫—Ç—ã</span>
                </button>
                <button id="storesTabBtn" data-icon="üè¨" aria-label="–û—Ç–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥–∫—É –ú–∞–≥–∞–∑–∏–Ω—ã">
                    <span class="text">–ú–∞–≥–∞–∑–∏–Ω—ã</span>
                </button>
                <button id="archiveTabBtn" data-icon="üìÅ" aria-label="–û—Ç–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥–∫—É –ê—Ä—Ö–∏–≤">
                    <span class="text">–ê—Ä—Ö–∏–≤</span>
                </button>
                <button id="authTabBtn" data-icon="üîë" aria-label="–û—Ç–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥–∫—É –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è">
                    <span class="text">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</span>
                </button>
                <button id="themeToggle" class="theme-toggle" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É"></button>
                <span class="auth-info" id="authInfo"></span>
            </div>
        </nav>
    </header>

    <div class="container">
        <div id="shopTab" class="tab active">
            <h2>–í–∞—à–∏ –ø–æ–∫—É–ø–∫–∏</h2>
            <div class="list-controls">
                <select id="listSelectForShop">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–∏—Å–æ–∫</option>
                </select>
            </div>
            <ul id="shoppingList"></ul>
            <div class="total-sum" id="totalSum">–ò—Ç–æ–≥–æ: 0.00</div>
        </div>

        <div id="listsTab" class="tab">
            <h2>–°–ø–∏—Å–∫–∏ –ø–æ–∫—É–ø–æ–∫</h2>
            <div class="lists-tab-content">
                <div class="lists-main">
                    <div class="list-controls">
                        <select id="listSelect">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–∏—Å–æ–∫</option>
                        </select>
                        <button class="secondary" id="newListBtn">–ù–æ–≤—ã–π —Å–ø–∏—Å–æ–∫</button>
                        <button class="secondary" id="downloadListBtn">–°–∫–∞—á–∞—Ç—å —Å–ø–∏—Å–æ–∫</button>
                        <button class="secondary" id="loadListBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                        <input type="file" id="loadFile" style="display: none;" accept=".json">
                    </div>
                    <ul id="listManagement"></ul>
                    <select id="storeSelect">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω</option>
                    </select>
                    <select id="deptSelect">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª</option>
                    </select>
                    <select id="productSelect">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç</option>
                    </select>
                    <button id="addItemFromSelectBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
                    <input type="text" id="customProduct" placeholder="–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π –ø—Ä–æ–¥—É–∫—Ç">
                    <div id="suggestions"></div>
                    <button id="addItemFromInputBtn">–î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–π</button>
                    <button id="saveAndSortBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button id="toggleSelectedItems" class="secondary">–ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏</button>
                    <ul id="shoppingList"></ul>
                </div>
                <div id="selectedItemsColumn">
                    <h3>–í—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏</h3>
                    <ul id="selectedItemsList"></ul>
                </div>
            </div>
        </div>

        <div id="productsTab" class="tab">
            <h2>–ü—Ä–æ–¥—É–∫—Ç—ã</h2>
            <select id="storeSelectForProducts">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω</option>
            </select>
            <select id="deptSelectForProducts">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª</option>
            </select>
            <input type="text" id="productName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞">
            <div class="quantity-controls">
                <button onclick="changeProductQuantity(-1)">‚àí</button>
                <input type="number" id="productQuantity" min="1" value="1">
                <button onclick="changeProductQuantity(1)">+</button>
            </div>
            <input type="text" id="productComment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
            <button id="addProductBtn">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</button>
            <ul id="productList"></ul>
        </div>

        <div id="storesTab" class="tab">
            <h2>–ú–∞–≥–∞–∑–∏–Ω—ã</h2>
            <input type="text" id="storeName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞">
            <button id="addStoreBtn">–î–æ–±–∞–≤–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω</button>
            <ul id="storeList"></ul>
            <h2>–û—Ç–¥–µ–ª—ã</h2>
            <select id="storeSelectForDept">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω</option>
            </select>
            <input type="text" id="deptName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª–∞">
            <input type="number" id="deptOrder" placeholder="–ü–æ—Ä—è–¥–æ–∫ –æ—Ç–¥–µ–ª–∞" min="1">
            <button id="addDepartmentBtn">–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–¥–µ–ª</button>
            <ul id="deptList"></ul>
        </div>

        <div id="archiveTab" class="tab">
            <h2>–ê—Ä—Ö–∏–≤ —Å–ø–∏—Å–∫–æ–≤</h2>
            <ul id="archiveList"></ul>
        </div>

        <div id="authTab" class="tab">
            <h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
            <input type="text" id="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
            <button id="loginBtn">–í–æ–π—Ç–∏</button>
            <button class="secondary" id="registerBtn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            <button class="secondary" id="logoutBtn">–í—ã–π—Ç–∏</button>
        </div>
    </div>

    <script>
        let shoppingLists = {};
        let defaultStores = {};
        let users = {};
        let currentUser = null;
        let selectedList = null;
        let selectedStore = null;
        let selectedSuggestionIndex = -1;
        let archiveTimeouts = {};

        function initTheme() {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            document.documentElement.setAttribute('data-theme', currentTheme === 'dark' ? 'light' : 'dark');
            console.log('Theme toggled to:', document.documentElement.getAttribute('data-theme'));
        }

        function toggleMenu() {
            const navMenu = document.getElementById('navMenu');
            const menuToggle = document.getElementById('menuToggle');
            if (navMenu && menuToggle) {
                navMenu.classList.toggle('open');
                menuToggle.textContent = navMenu.classList.contains('open') ? '‚úï' : '‚ò∞';
            }
        }

        function showTab(tabId, btnId) {
            console.log(`Attempting to show tab: ${tabId} with button: ${btnId}`);
            const tab = document.getElementById(tabId);
            const btn = document.getElementById(btnId);
            if (!tab || !btn) {
                console.warn(`Tab (${tabId}) or Button (${btnId}) not found`);
                return;
            }

            document.querySelectorAll('.tab.active').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('nav button.active').forEach(btn => btn.classList.remove('active'));

            tab.classList.add('active');
            btn.classList.add('active');

            // Close menu on mobile after tab selection
            const navMenu = document.getElementById('navMenu');
            const menuToggle = document.getElementById('menuToggle');
            if (navMenu && navMenu.classList.contains('open') && window.innerWidth <= 430) {
                navMenu.classList.remove('open');
                if (menuToggle) menuToggle.textContent = '‚ò∞';
            }

            if (tabId === 'storesTab') {
                updateStoreList();
            } else if (tabId === 'productsTab') {
                updateProductList();
            } else if (tabId === 'listsTab') {
                updateListManagement();
                updateSelectedItemsColumn();
            } else if (tabId === 'archiveTab') {
                updateArchiveList();
            }
            console.log(`Tab switched to: ${tabId}`);
        }

        async function loadUsers() {
            try {
                const pingResponse = await fetch('/api/ping', { method: 'HEAD', timeout: 5000 });
                if (!pingResponse.ok) throw new Error(`Server ping failed with status: ${pingResponse.status}`);

                const response = await fetch('/api/users', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                users = await response.json() || {};
                localStorage.setItem('users', JSON.stringify(users));
                console.log('Users successfully fetched from server');
            } catch (e) {
                console.warn('Failed to fetch users from server, using localStorage fallback:', e.message);
                const localUsers = localStorage.getItem('users');
                users = localUsers ? JSON.parse(localUsers) : {};
            }
            Object.values(users).forEach(user => {
                if (!user.archive) user.archive = {};
                Object.values(user.stores || {}).forEach(store => {
                    store.departments.forEach(dept => {
                        if (dept.products.some(p => typeof p === 'string')) {
                            dept.products = dept.products.map(p => typeof p === 'string' ? { name: p, quantity: 1, comment: '' } : p);
                        }
                    });
                });
                Object.values(user.lists || {}).forEach(list => {
                    list.items.forEach(item => {
                        if (item.image) delete item.image;
                    });
                });
                Object.values(user.archive || {}).forEach(list => {
                    list.items.forEach(item => {
                        if (item.image) delete item.image;
                    });
                });
            });
        }

        async function saveUsers() {
            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(users)
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                console.log('Users saved to server');
                localStorage.setItem('users', JSON.stringify(users));
            } catch (e) {
                console.warn('Error saving users to server, saving to localStorage:', e.message);
                localStorage.setItem('users', JSON.stringify(users));
            }
        }

        function register() {
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            if (!usernameInput || !passwordInput) return;

            const username = usernameInput.value;
            const password = passwordInput.value;

            if (!username || !password) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å!');
                return;
            }

            if (users[username]) {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
                return;
            }

            users[username] = { password, lists: {}, stores: {}, archive: {} };
            saveUsers();
            alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏.');
            usernameInput.value = '';
            passwordInput.value = '';
        }

        async function login() {
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            if (!usernameInput || !passwordInput) return;

            const username = usernameInput.value;
            const password = passwordInput.value;

            if (!username || !password) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å!');
                return;
            }

            await loadUsers();
            if (!users[username]) {
                users[username] = { password, lists: {}, stores: {}, archive: {} };
                await saveUsers();
            }

            if (users[username].password === password) {
                currentUser = username;
                localStorage.setItem('currentUser', currentUser); // Persist currentUser
                shoppingLists = users[username].lists || {};
                defaultStores = users[username].stores || {};
                updateAuthState();
                updateListSelect();
                updateStoreSelect();
                updateStoreList();
                updateProductList();
                updateListManagement();
                updateArchiveList();
                alert('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!');
            } else {
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser'); // Clear currentUser
            shoppingLists = {};
            defaultStores = {};
            selectedList = null;
            selectedStore = null;
            Object.keys(archiveTimeouts).forEach(list => clearTimeout(archiveTimeouts[list]));
            archiveTimeouts = {};
            updateAuthState();
            updateListSelect();
            updateStoreSelect();
            updateShoppingList();
            updateStoreList();
            updateProductList();
            updateListManagement();
            updateArchiveList();
            updateSelectedItemsColumn();
        }

        function updateAuthState() {
            const authInfo = document.getElementById('authInfo');
            if (authInfo) {
                authInfo.textContent = currentUser ? `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${currentUser}` : '';
            }
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            if (usernameInput) usernameInput.value = '';
            if (passwordInput) passwordInput.value = '';
        }

        function saveShoppingLists() {
            if (currentUser && users[currentUser]) {
                users[currentUser].lists = shoppingLists;
                users[currentUser].stores = defaultStores;
                users[currentUser].archive = users[currentUser].archive || {};
                saveUsers();
                localStorage.setItem('users', JSON.stringify(users));
            }
        }

        function updateListSelect() {
            const listSelect = document.getElementById('listSelect');
            const listSelectForShop = document.getElementById('listSelectForShop');
            if (!listSelect || !listSelectForShop) return;

            listSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–∏—Å–æ–∫</option>';
            listSelectForShop.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–∏—Å–æ–∫</option>';
            Object.keys(shoppingLists).forEach(list => {
                const option = document.createElement('option');
                option.value = list;
                option.textContent = list;
                listSelect.appendChild(option);
                listSelectForShop.appendChild(option.cloneNode(true));
            });
        }

        function updateListManagement() {
            const listManagement = document.getElementById('listManagement');
            if (!listManagement) return;

            listManagement.innerHTML = '';
            Object.keys(shoppingLists).forEach(list => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${list}</span>
                    <div class="edit-delete-controls">
                        <button onclick="editList('${list}')">‚úèÔ∏è</button>
                        <button onclick="deleteList('${list}')">üóëÔ∏è</button>
                    </div>
                `;
                listManagement.appendChild(li);
            });
        }

        function editList(oldName) {
            const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞:', oldName);
            if (newName && newName !== oldName && !shoppingLists[newName]) {
                shoppingLists[newName] = shoppingLists[oldName];
                delete shoppingLists[oldName];
                if (selectedList === oldName) selectedList = newName;
                if (archiveTimeouts[oldName]) {
                    clearTimeout(archiveTimeouts[oldName]);
                    delete archiveTimeouts[oldName];
                }
                saveShoppingLists();
                updateListSelect();
                updateListManagement();
                updateShoppingList();
                updateSelectedItemsColumn();
            } else if (shoppingLists[newName]) {
                alert('–°–ø–∏—Å–æ–∫ —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
            }
        }

        function deleteList(listName) {
            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–ø–∏—Å–æ–∫ "${listName}"?`)) {
                delete shoppingLists[listName];
                if (selectedList === listName) selectedList = null;
                if (archiveTimeouts[listName]) {
                    clearTimeout(archiveTimeouts[listName]);
                    delete archiveTimeouts[listName];
                }
                saveShoppingLists();
                updateListSelect();
                updateListManagement();
                updateShoppingList();
                updateSelectedItemsColumn();
            }
        }

        function archiveList(listName) {
            if (!shoppingLists[listName] || !currentUser) return;
            users[currentUser].archive = users[currentUser].archive || {};
            users[currentUser].archive[listName] = {
                name: listName,
                store: shoppingLists[listName].store,
                items: shoppingLists[listName].items,
                archivedAt: new Date().toISOString()
            };
            delete shoppingLists[listName];
            if (selectedList === listName) selectedList = null;
            delete archiveTimeouts[listName];
            saveShoppingLists();
            updateListSelect();
            updateListManagement();
            updateShoppingList();
            updateArchiveList();
            updateSelectedItemsColumn();
        }

        function updateArchiveList() {
            const archiveList = document.getElementById('archiveList');
            if (!archiveList || !currentUser) return;

            archiveList.innerHTML = '';
            const archive = users[currentUser]?.archive || {};
            Object.values(archive).forEach(list => {
                const li = document.createElement('li');
                let itemsHtml = '<ul>';
                list.items.forEach(item => {
                    itemsHtml += `
                        <li class="completed">
                            ${item.dept ? `${item.name} (${item.dept.name})` : item.name}
                            (–ö–æ–ª-–≤–æ: ${item.quantity}, –¶–µ–Ω–∞: ${item.price > 0 ? item.price : '-'}, –ö–æ–º–º–µ–Ω—Ç: ${item.comment || '-'})
                        </li>
                    `;
                });
                itemsHtml += '</ul>';
                li.innerHTML = `
                    <span>${list.name} (–ú–∞–≥–∞–∑–∏–Ω: ${list.store || '-'}, –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–æ: ${new Date(list.archivedAt).toLocaleString()})</span>
                    ${itemsHtml}
                `;
                archiveList.appendChild(li);
            });
        }

        function updateStoreSelect() {
            const storeSelect = document.getElementById('storeSelect');
            const storeSelectForDept = document.getElementById('storeSelectForDept');
            const storeSelectForProducts = document.getElementById('storeSelectForProducts');
            if (!storeSelect || !storeSelectForDept || !storeSelectForProducts) return;

            storeSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω</option>';
            storeSelectForDept.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω</option>';
            storeSelectForProducts.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω</option>';
            Object.keys(defaultStores).forEach(store => {
                const option = document.createElement('option');
                option.value = store;
                option.textContent = store;
                storeSelect.appendChild(option);
                storeSelectForDept.appendChild(option.cloneNode(true));
                storeSelectForProducts.appendChild(option.cloneNode(true));
            });
            updateDeptSelect();
            updateDeptSelectForProducts();
        }

        function updateDeptSelect() {
            const storeSelect = document.getElementById('storeSelect');
            const deptSelect = document.getElementById('deptSelect');
            if (!storeSelect || !deptSelect) return;

            const storeName = storeSelect.value;
            deptSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª</option>';
            if (storeName && defaultStores[storeName]) {
                defaultStores[storeName].departments.sort((a, b) => a.order - b.order).forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.name;
                    option.textContent = dept.name;
                    deptSelect.appendChild(option);
                });
            }
            updateProductSelect();
        }

        function updateDeptSelectForProducts() {
            const storeSelect = document.getElementById('storeSelectForProducts');
            const deptSelect = document.getElementById('deptSelectForProducts');
            if (!storeSelect || !deptSelect) return;

            const storeName = storeSelect.value;
            deptSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª</option>';
            if (storeName && defaultStores[storeName]) {
                defaultStores[storeName].departments.sort((a, b) => a.order - b.order).forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.name;
                    option.textContent = dept.name;
                    deptSelect.appendChild(option);
                });
            }
            updateProductList();
        }

        function updateProductSelect() {
            const storeSelect = document.getElementById('storeSelect');
            const deptSelect = document.getElementById('deptSelect');
            const productSelect = document.getElementById('productSelect');
            if (!storeSelect || !deptSelect || !productSelect) return;

            const storeName = storeSelect.value;
            const deptName = deptSelect.value;
            productSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç</option>';
            if (storeName && deptName && defaultStores[storeName]) {
                const dept = defaultStores[storeName].departments.find(d => d.name === deptName);
                if (dept) {
                    dept.products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.name;
                        option.textContent = `${product.name} (–ö–æ–ª-–≤–æ: ${product.quantity}, –ö–æ–º–º–µ–Ω—Ç: ${product.comment || '-'})`;
                        productSelect.appendChild(option);
                    });
                }
            }
        }

        function createNewList() {
            let listName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞:', `–°–ø–∏—Å–æ–∫ ${Object.keys(shoppingLists).length + 1}`);
            if (listName && !shoppingLists[listName]) {
                shoppingLists[listName] = { store: '', items: [] };
                selectedList = listName;
                saveShoppingLists();
                updateListSelect();
                updateListManagement();
                updateShoppingList();
                updateSelectedItemsColumn();
            } else if (shoppingLists[listName]) {
                alert('–°–ø–∏—Å–æ–∫ —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
            }
        }

        function addStore() {
            const storeNameInput = document.getElementById('storeName');
            if (!storeNameInput) return;

            const storeName = storeNameInput.value;
            if (storeName && !defaultStores[storeName]) {
                defaultStores[storeName] = { departments: [] };
                saveShoppingLists();
                updateStoreSelect();
                updateStoreList();
                storeNameInput.value = '';
            } else if (defaultStores[storeName]) {
                alert('–ú–∞–≥–∞–∑–∏–Ω —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
            }
        }

        function editStore(oldName) {
            const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞:', oldName);
            if (newName && newName !== oldName && !defaultStores[newName]) {
                defaultStores[newName] = defaultStores[oldName];
                delete defaultStores[oldName];
                Object.values(shoppingLists).forEach(list => {
                    if (list.store === oldName) list.store = newName;
                });
                if (users[currentUser]?.archive) {
                    Object.values(users[currentUser].archive).forEach(list => {
                        if (list.store === oldName) list.store = newName;
                    });
                }
                saveShoppingLists();
                updateStoreSelect();
                updateStoreList();
            } else if (defaultStores[newName]) {
                alert('–ú–∞–≥–∞–∑–∏–Ω —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
            }
        }

        function deleteStore(storeName) {
            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω "${storeName}"?`)) {
                delete defaultStores[storeName];
                Object.values(shoppingLists).forEach(list => {
                    if (list.store === storeName) list.store = '';
                });
                if (users[currentUser]?.archive) {
                    Object.values(users[currentUser].archive).forEach(list => {
                        if (list.store === storeName) list.store = '';
                    });
                }
                saveShoppingLists();
                updateStoreSelect();
                updateStoreList();
            }
        }

        function addDepartment() {
            const storeSelectForDept = document.getElementById('storeSelectForDept');
            const deptNameInput = document.getElementById('deptName');
            const deptOrderInput = document.getElementById('deptOrder');
            if (!storeSelectForDept || !deptNameInput || !deptOrderInput) return;

            const storeName = storeSelectForDept.value;
            const deptName = deptNameInput.value;
            const deptOrder = parseInt(deptOrderInput.value) || 1;
            if (storeName && deptName && defaultStores[storeName]) {
                const existingDept = defaultStores[storeName].departments.find(d => d.name === deptName);
                if (!existingDept) {
                    defaultStores[storeName].departments.push({
                        name: deptName,
                        order: deptOrder,
                        products: []
                    });
                    saveShoppingLists();
                    updateDeptList();
                    deptNameInput.value = '';
                    deptOrderInput.value = '';
                } else {
                    alert('–û—Ç–¥–µ–ª —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
                }
            } else {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω –∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª–∞!');
            }
        }

        function editDepartment(storeName, oldDeptName) {
            const newDeptName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª–∞:', oldDeptName);
            const newOrder = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–æ—Ä—è–¥–æ–∫ –æ—Ç–¥–µ–ª–∞:', defaultStores[storeName].departments.find(d => d.name === oldDeptName).order);
            if (newDeptName && newDeptName !== oldDeptName && !defaultStores[storeName].departments.find(d => d.name === newDeptName)) {
                const dept = defaultStores[storeName].departments.find(d => d.name === oldDeptName);
                dept.name = newDeptName;
                dept.order = parseInt(newOrder) || dept.order;
                Object.values(shoppingLists).forEach(list => {
                    list.items.forEach(item => {
                        if (item.dept?.name === oldDeptName) item.dept.name = newDeptName;
                    });
                });
                if (users[currentUser]?.archive) {
                    Object.values(users[currentUser].archive).forEach(list => {
                        list.items.forEach(item => {
                            if (item.dept?.name === oldDeptName) item.dept.name = newDeptName;
                        });
                    });
                }
                saveShoppingLists();
                updateDeptList();
            } else if (defaultStores[storeName].departments.find(d => d.name === newDeptName)) {
                alert('–û—Ç–¥–µ–ª —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
            }
        }

        function deleteDepartment(storeName, deptName) {
            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –æ—Ç–¥–µ–ª "${deptName}"?`)) {
                defaultStores[storeName].departments = defaultStores[storeName].departments.filter(d => d.name !== deptName);
                Object.values(shoppingLists).forEach(list => {
                    list.items.forEach(item => {
                        if (item.dept?.name === deptName) item.dept = null;
                    });
                });
                if (users[currentUser]?.archive) {
                    Object.values(users[currentUser].archive).forEach(list => {
                        list.items.forEach(item => {
                            if (item.dept?.name === deptName) item.dept = null;
                        });
                    });
                }
                saveShoppingLists();
                updateDeptList();
            }
        }

        function updateStoreList() {
            const storeList = document.getElementById('storeList');
            if (!storeList) return;

            storeList.innerHTML = '';
            Object.keys(defaultStores).forEach(store => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${store}</span>
                    <div class="edit-delete-controls">
                        <button onclick="editStore('${store}')">‚úèÔ∏è</button>
                        <button onclick="deleteStore('${store}')">üóëÔ∏è</button>
                    </div>
                `;
                storeList.appendChild(li);
            });
            updateDeptList();
        }

        function updateDeptList() {
            const storeSelectForDept = document.getElementById('storeSelectForDept');
            const deptList = document.getElementById('deptList');
            if (!storeSelectForDept || !deptList) return;

            const storeName = storeSelectForDept.value;
            deptList.innerHTML = '';
            if (storeName && defaultStores[storeName]) {
                defaultStores[storeName].departments.sort((a, b) => a.order - b.order).forEach(dept => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>${dept.name} (–ü–æ—Ä—è–¥–æ–∫: ${dept.order})</span>
                        <div class="edit-delete-controls">
                            <button onclick="editDepartment('${storeName}', '${dept.name}')">‚úèÔ∏è</button>
                            <button onclick="deleteDepartment('${storeName}', '${dept.name}')">üóëÔ∏è</button>
                        </div>
                    `;
                    deptList.appendChild(li);
                });
            }
        }

        function changeProductQuantity(delta) {
            const quantityInput = document.getElementById('productQuantity');
            if (quantityInput) {
                quantityInput.value = Math.max(1, parseInt(quantityInput.value) + delta);
            }
        }

        function addProduct() {
            const storeSelect = document.getElementById('storeSelectForProducts');
            const deptSelect = document.getElementById('deptSelectForProducts');
            const productNameInput = document.getElementById('productName');
            const quantityInput = document.getElementById('productQuantity');
            const commentInput = document.getElementById('productComment');
            if (!storeSelect || !deptSelect || !productNameInput || !quantityInput || !commentInput) return;

            const storeName = storeSelect.value;
            const deptName = deptSelect.value;
            const productName = productNameInput.value;
            const quantity = parseInt(quantityInput.value) || 1;
            const comment = commentInput.value;

            if (!storeName || !deptName || !productName) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω, –æ—Ç–¥–µ–ª –∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞!');
                return;
            }

            const dept = defaultStores[storeName].departments.find(d => d.name === deptName);
            if (dept) {
                if (!dept.products.find(p => p.name === productName)) {
                    dept.products.push({ name: productName, quantity, comment });
                    saveShoppingLists();
                    updateProductList();
                    updateProductSelect();
                    productNameInput.value = '';
                    quantityInput.value = '1';
                    commentInput.value = '';
                } else {
                    alert('–ü—Ä–æ–¥—É–∫—Ç —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —ç—Ç–æ–º –æ—Ç–¥–µ–ª–µ!');
                }
            }
        }

        function updateProductList() {
            const storeSelect = document.getElementById('storeSelectForProducts');
            const deptSelect = document.getElementById('deptSelectForProducts');
            const productList = document.getElementById('productList');
            if (!storeSelect || !deptSelect || !productList) return;

            const storeName = storeSelect.value;
            const deptName = deptSelect.value;
            productList.innerHTML = '';
            if (storeName && deptName && defaultStores[storeName]) {
                const dept = defaultStores[storeName].departments.find(d => d.name === deptName);
                if (dept) {
                    dept.products.forEach(product => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <span>${product.name} (–ö–æ–ª-–≤–æ: ${product.quantity}, –ö–æ–º–º–µ–Ω—Ç: ${product.comment || '-'})</span>
                            <div class="edit-delete-controls">
                                <button onclick="editProduct('${storeName}', '${deptName}', '${product.name}')">‚úèÔ∏è</button>
                                <button onclick="deleteProduct('${storeName}', '${deptName}', '${product.name}')">üóëÔ∏è</button>
                            </div>
                        `;
                        productList.appendChild(li);
                    });
                }
            }
        }

        function editProduct(storeName, deptName, oldProductName) {
            const dept = defaultStores[storeName].departments.find(d => d.name === deptName);
            if (!dept) return;

            const product = dept.products.find(p => p.name === oldProductName);
            const newProductName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞:', oldProductName);
            const newQuantity = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:', product.quantity);
            const newComment = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:', product.comment || '');

            if (newProductName && newProductName !== oldProductName && !dept.products.find(p => p.name === newProductName)) {
                product.name = newProductName;
                product.quantity = parseInt(newQuantity) || product.quantity;
                product.comment = newComment;
                Object.values(shoppingLists).forEach(list => {
                    list.items.forEach(item => {
                        if (item.name === oldProductName && item.dept?.name === deptName) {
                            item.name = newProductName;
                        }
                    });
                });
                if (users[currentUser]?.archive) {
                    Object.values(users[currentUser].archive).forEach(list => {
                        list.items.forEach(item => {
                            if (item.name === oldProductName && item.dept?.name === deptName) {
                                item.name = newProductName;
                            }
                        });
                    });
                }
                saveShoppingLists();
                updateProductList();
                updateProductSelect();
            } else if (dept.products.find(p => p.name === newProductName)) {
                alert('–ü—Ä–æ–¥—É–∫—Ç —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
            }
        }

        function deleteProduct(storeName, deptName, productName) {
            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç "${productName}"?`)) {
                const dept = defaultStores[storeName].departments.find(d => d.name === deptName);
                if (dept) {
                    dept.products = dept.products.filter(p => p.name !== productName);
                    Object.values(shoppingLists).forEach(list => {
                        list.items = list.items.filter(item => !(item.name === productName && item.dept?.name === deptName));
                    });
                    if (users[currentUser]?.archive) {
                        Object.values(users[currentUser].archive).forEach(list => {
                            list.items = list.items.filter(item => !(item.name === productName && item.dept?.name === deptName));
                        });
                    }
                    saveShoppingLists();
                    updateProductList();
                    updateProductSelect();
                }
            }
        }

        function suggestProducts(input) {
            const suggestions = document.getElementById('suggestions');
            if (!suggestions) return;

            suggestions.innerHTML = '';
            selectedSuggestionIndex = -1;
            if (input && selectedStore && defaultStores[selectedStore]) {
                const matches = defaultStores[selectedStore].departments.flatMap(dept =>
                    dept.products.filter(p => p.name.toLowerCase().includes(input.toLowerCase())).map(p => ({ product: p, dept }))
                );
                matches.forEach(({ product, dept }) => {
                    const div = document.createElement('div');
                    div.textContent = `${product.name} (${dept.name})`;
                    div.onclick = () => {
                        const customProductInput = document.getElementById('customProduct');
                        if (customProductInput) {
                            customProductInput.value = product.name;
                            suggestions.innerHTML = '';
                            addItemFromInput();
                        }
                    };
                    suggestions.appendChild(div);
                });
            }
        }

        function handleKey(event) {
            const suggestions = document.getElementById('suggestions')?.children;
            if (!suggestions || suggestions.length === 0) return;

            if (event.key === 'ArrowDown') {
                selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestions.length - 1);
                updateSuggestionHighlight();
            } else if (event.key === 'ArrowUp') {
                selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                updateSuggestionHighlight();
            } else if (event.key === 'Enter' && selectedSuggestionIndex >= 0) {
                const customProductInput = document.getElementById('customProduct');
                if (customProductInput) {
                    customProductInput.value = suggestions[selectedSuggestionIndex].textContent;
                    document.getElementById('suggestions').innerHTML = '';
                    addItemFromInput();
                    event.preventDefault();
                }
            }
        }

        function updateSuggestionHighlight() {
            const suggestions = document.getElementById('suggestions')?.children;
            if (!suggestions) return;

            for (let i = 0; i < suggestions.length; i++) {
                suggestions[i].style.background = i === selectedSuggestionIndex ? 'var(--background)' : 'var(--card-background)';
            }
        }

        function findDepartment(productName) {
            if (selectedStore && defaultStores[selectedStore]) {
                return defaultStores[selectedStore].departments.find(dept => dept.products.some(p => p.name === productName));
            }
            return null;
        }

        function ensureSelectedList() {
            if (!selectedList || !shoppingLists[selectedList]) {
                const listNames = Object.keys(shoppingLists);
                if (listNames.length > 0) {
                    selectedList = listNames[0];
                } else {
                    let newListName = `–°–ø–∏—Å–æ–∫ ${listNames.length + 1}`;
                    shoppingLists[newListName] = { store: '', items: [] };
                    selectedList = newListName;
                    saveShoppingLists();
                    updateListSelect();
                    updateListManagement();
                }
            }
            return selectedList;
        }

        function addItemFromSelect() {
            const storeSelect = document.getElementById('storeSelect');
            const deptSelect = document.getElementById('deptSelect');
            const productSelect = document.getElementById('productSelect');
            if (!storeSelect || !deptSelect || !productSelect) return;

            const storeName = storeSelect.value;
            const deptName = deptSelect.value;
            const productName = productSelect.value;

            console.log('Adding item from select:', { storeName, deptName, productName, selectedList });

            if (!storeName) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω!');
                return;
            }

            if (productName && deptName) {
                selectedStore = storeName;
                ensureSelectedList();
                shoppingLists[selectedList].store = storeName;
                const dept = defaultStores[storeName].departments.find(d => d.name === deptName);
                const product = dept.products.find(p => p.name === productName);

                // Check for existing item
                const existingItem = shoppingLists[selectedList].items.find(
                    item => item.name === productName && item.dept?.name === deptName
                );
                if (existingItem) {
                    existingItem.quantity += product.quantity;
                    existingItem.comment = product.comment || existingItem.comment;
                    existingItem.price = existingItem.price || 0;
                } else {
                    shoppingLists[selectedList].items.push({
                        name: productName,
                        dept: dept ? { name: dept.name, order: dept.order } : null,
                        isCustom: false,
                        quantity: product.quantity,
                        comment: product.comment || '',
                        price: 0,
                        completed: false
                    });
                }

                saveShoppingLists();
                productSelect.value = '';
                updateShoppingList();
                updateSelectedItemsColumn();
            } else {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª –∏ –ø—Ä–æ–¥—É–∫—Ç!');
            }
        }

        function addItemFromInput() {
            const storeSelect = document.getElementById('storeSelect');
            const customProductInput = document.getElementById('customProduct');
            if (!storeSelect || !customProductInput) return;

            const storeName = storeSelect.value;
            const customProduct = customProductInput.value;

            console.log('Adding item from input:', { storeName, customProduct, selectedList });

            if (!storeName) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω!');
                return;
            }

            if (customProduct) {
                selectedStore = storeName;
                ensureSelectedList();
                shoppingLists[selectedList].store = storeName;
                const existingDept = findDepartment(customProduct);

                // Check for existing item
                const existingItem = shoppingLists[selectedList].items.find(
                    item => item.name === customProduct && (!item.dept || item.dept.name === (existingDept?.name || null))
                );
                if (existingItem) {
                    existingItem.quantity += 1;
                    existingItem.comment = existingItem.comment || '';
                    existingItem.price = existingItem.price || 0;
                } else {
                    shoppingLists[selectedList].items.push({
                        name: customProduct,
                        dept: existingDept ? { name: existingDept.name, order: existingDept.order } : null,
                        isCustom: !existingDept,
                        quantity: 1,
                        comment: '',
                        price: 0,
                        completed: false
                    });
                }

                saveShoppingLists();
                customProductInput.value = '';
                document.getElementById('suggestions').innerHTML = '';
                updateShoppingList();
                updateSelectedItemsColumn();
            } else {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞!');
            }
        }

        function saveAndSort() {
            if (!selectedList || !selectedStore) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –∏ –º–∞–≥–∞–∑–∏–Ω!');
                return;
            }
            shoppingLists[selectedList].items.sort((a, b) => {
                if (a.isCustom && !b.isCustom) return 1;
                if (!a.isCustom && b.isCustom) return -1;
                return (a.dept ? a.dept.order : Infinity) - (b.dept ? b.dept.order : Infinity);
            });
            saveShoppingLists();
            updateShoppingList();
            updateSelectedItemsColumn();
        }

        function calculateTotalSum(listName) {
            if (!listName || !shoppingLists[listName]) return 0;
            return shoppingLists[listName].items.reduce((sum, item) => {
                const price = parseFloat(item.price) || 0;
                return sum + (item.quantity * price);
            }, 0).toFixed(2);
        }

        function checkAndScheduleArchive(listName) {
            if (!shoppingLists[listName] || archiveTimeouts[listName]) return;
            const allCompleted = shoppingLists[listName].items.every(item => item.completed);
            if (allCompleted && shoppingLists[listName].items.length > 0) {
                archiveTimeouts[listName] = setTimeout(() => {
                    archiveList(listName);
                }, 10 * 60 * 1000);
            }
        }

        function updateShoppingList() {
            const list = document.getElementById('shoppingList');
            const totalSum = document.getElementById('totalSum');
            if (!list || !totalSum) return;

            list.innerHTML = '';
            const listSelectForShop = document.getElementById('listSelectForShop');
            if (!listSelectForShop) return;

            const selectedListForShop = listSelectForShop.value || selectedList;
            if (selectedListForShop && shoppingLists[selectedListForShop]) {
                selectedStore = shoppingLists[selectedListForShop].store;
                const isMobile = window.innerWidth <= 430;
                shoppingLists[selectedListForShop].items.forEach((item, index) => {
                    const li = document.createElement('li');
                    if (isMobile) {
                        li.innerHTML = `
                            <span style="flex-grow: 1;">${item.dept ? `${item.name} (${item.dept.name})` : item.name}</span>
                            <span class="quantity-display" onclick="toggleQuantityInput(${index}, this)">${item.quantity}</span>
                            <input type="number" class="mobile-input quantity-input" min="1" value="${item.quantity}" style="display: none;" onchange="updateQuantity('${selectedListForShop}', ${index}, this.value)">
                            <div class="mobile-item-controls">
                                <button onclick="toggleCommentInput(${index}, this)">‚úçÔ∏è</button>
                                <input type="text" class="mobile-input comment-input" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" value="${item.comment || ''}" style="display: none;" oninput="updateComment('${selectedListForShop}', ${index}, this.value)">
                                <button onclick="togglePriceInput(${index}, this)">üíµ</button>
                                <input type="number" class="mobile-input price-input" placeholder="–¶–µ–Ω–∞" step="0.01" min="0" value="${item.price > 0 ? item.price : ''}" style="display: none;" oninput="updatePrice('${selectedListForShop}', ${index}, this.value)">
                            </div>
                        `;
                    } else {
                        li.innerHTML = `
                            <span>${item.dept ? `${item.name} (${item.dept.name})` : item.name}</span>
                            <div class="quantity-controls">
                                <button onclick="changeQuantity('${selectedListForShop}', ${index}, -1)">‚àí</button>
                                <input type="number" min="1" value="${item.quantity}" onchange="updateQuantity('${selectedListForShop}', ${index}, this.value)">
                                <button onclick="changeQuantity('${selectedListForShop}', ${index}, 1)">+</button>
                            </div>
                            <input type="text" class="comment-input" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" value="${item.comment || ''}" oninput="updateComment('${selectedListForShop}', ${index}, this.value)">
                            <input type="number" class="price-input" placeholder="–¶–µ–Ω–∞" step="0.01" min="0" value="${item.price > 0 ? item.price : ''}" oninput="updatePrice('${selectedListForShop}', ${index}, this.value)">
                        `;
                    }
                    li.onclick = (e) => {
                        if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT' && e.target.className !== 'quantity-display') {
                            item.completed = !item.completed;
                            li.classList.toggle('completed', item.completed);
                            saveShoppingLists();
                            totalSum.textContent = `–ò—Ç–æ–≥–æ: ${calculateTotalSum(selectedListForShop)}`;
                            checkAndScheduleArchive(selectedListForShop);
                            updateSelectedItemsColumn();
                        }
                    };
                    if (item.completed) li.classList.add('completed');
                    list.appendChild(li);
                });
                totalSum.textContent = `–ò—Ç–æ–≥–æ: ${calculateTotalSum(selectedListForShop)}`;
                checkAndScheduleArchive(selectedListForShop);
            } else {
                totalSum.textContent = `–ò—Ç–æ–≥–æ: 0.00`;
            }
        }

        function toggleQuantityInput(index, element) {
            const input = element.nextElementSibling;
            if (input.style.display === 'none') {
                input.style.display = 'block';
                element.style.display = 'none';
                input.focus();
            }
        }

        function toggleCommentInput(index, element) {
            const input = element.nextElementSibling;
            input.style.display = input.style.display === 'none' ? 'block' : 'none';
            if (input.style.display === 'block') input.focus();
        }

        function togglePriceInput(index, element) {
            const input = element.nextElementSibling;
            input.style.display = input.style.display === 'none' ? 'block' : 'none';
            if (input.style.display === 'block') input.focus();
        }

        function updateSelectedItemsColumn() {
            const column = document.getElementById('selectedItemsColumn');
            const list = document.getElementById('selectedItemsList');
            if (!column || !list) return;

            list.innerHTML = '';
            if (selectedList && shoppingLists[selectedList]) {
                column.classList.add('active');
                shoppingLists[selectedList].items.forEach((item, index) => {
                    if (item.completed) {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <span>${item.dept ? `${item.name} (${item.dept.name})` : item.name}</span>
                            <span>–ö–æ–ª-–≤–æ: ${item.quantity}</span>
                            <span>–¶–µ–Ω–∞: ${item.price > 0 ? item.price : '-'}</span>
                            <span>–ö–æ–º–º–µ–Ω—Ç: ${item.comment || '-'}</span>
                        `;
                        list.appendChild(li);
                    }
                });
            } else {
                column.classList.remove('active');
            }
        }

        function changeQuantity(listName, index, delta) {
            if (shoppingLists[listName] && shoppingLists[listName].items[index]) {
                shoppingLists[listName].items[index].quantity = Math.max(1, shoppingLists[listName].items[index].quantity + delta);
                saveShoppingLists();
                updateShoppingList();
                updateSelectedItemsColumn();
            }
        }

        function updateQuantity(listName, index, value) {
            if (shoppingLists[listName] && shoppingLists[listName].items[index]) {
                shoppingLists[listName].items[index].quantity = Math.max(1, parseInt(value) || 1);
                saveShoppingLists();
                updateShoppingList();
                updateSelectedItemsColumn();
            }
        }

        function updateComment(listName, index, value) {
            if (shoppingLists[listName] && shoppingLists[listName].items[index]) {
                shoppingLists[listName].items[index].comment = value;
                saveShoppingLists();
                updateShoppingList();
                updateSelectedItemsColumn();
            }
        }

        function updatePrice(listName, index, value) {
            if (shoppingLists[listName] && shoppingLists[listName].items[index]) {
                shoppingLists[listName].items[index].price = parseFloat(value) || 0;
                saveShoppingLists();
                updateShoppingList();
                updateSelectedItemsColumn();
            }
        }

        function downloadList() {
            if (!selectedList || !shoppingLists[selectedList]) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è!');
                return;
            }
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(shoppingLists[selectedList]));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `${selectedList}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function loadList(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const listData = JSON.parse(e.target.result);
                    const listName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞:', listData.name || '–ù–æ–≤—ã–π —Å–ø–∏—Å–æ–∫');
                    if (listName && !shoppingLists[listName]) {
                        shoppingLists[listName] = listData;
                        selectedList = listName;
                        saveShoppingLists();
                        updateListSelect();
                        updateListManagement();
                        updateShoppingList();
                        updateSelectedItemsColumn();
                    } else if (shoppingLists[listName]) {
                        alert('–°–ø–∏—Å–æ–∫ —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
                    }
                } catch (err) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞!');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await loadUsers();

            // Restore currentUser from localStorage
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser && users[storedUser]) {
                currentUser = storedUser;
                shoppingLists = users[currentUser].lists || {};
                defaultStores = users[currentUser].stores || {};
                updateAuthState();
                updateListSelect();
                updateStoreSelect();
                updateStoreList();
                updateProductList();
                updateListManagement();
                updateArchiveList();
                updateShoppingList();
                updateSelectedItemsColumn();
            }

            initTheme();
            updateAuthState();

            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('menuToggle').addEventListener('click', toggleMenu);
            document.getElementById('shopTabBtn').addEventListener('click', () => showTab('shopTab', 'shopTabBtn'));
            document.getElementById('listsTabBtn').addEventListener('click', () => showTab('listsTab', 'listsTabBtn'));
            document.getElementById('productsTabBtn').addEventListener('click', () => showTab('productsTab', 'productsTabBtn'));
            document.getElementById('storesTabBtn').addEventListener('click', () => showTab('storesTab', 'storesTabBtn'));
            document.getElementById('archiveTabBtn').addEventListener('click', () => showTab('archiveTab', 'archiveTabBtn'));
            document.getElementById('authTabBtn').addEventListener('click', () => showTab('authTab', 'authTabBtn'));
            document.getElementById('loginBtn').addEventListener('click', login);
            document.getElementById('registerBtn').addEventListener('click', register);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('newListBtn').addEventListener('click', createNewList);
            document.getElementById('addStoreBtn').addEventListener('click', addStore);
            document.getElementById('addDepartmentBtn').addEventListener('click', addDepartment);
            document.getElementById('addProductBtn').addEventListener('click', addProduct);
            document.getElementById('addItemFromSelectBtn').addEventListener('click', addItemFromSelect);
            document.getElementById('addItemFromInputBtn').addEventListener('click', addItemFromInput);
            document.getElementById('saveAndSortBtn').addEventListener('click', saveAndSort);
            document.getElementById('downloadListBtn').addEventListener('click', downloadList);
            document.getElementById('loadListBtn').addEventListener('click', () => document.getElementById('loadFile').click());
            document.getElementById('loadFile').addEventListener('change', loadList);
            document.getElementById('toggleSelectedItems').addEventListener('click', () => {
                const column = document.getElementById('selectedItemsColumn');
                column.classList.toggle('active');
            });

            document.getElementById('storeSelect').addEventListener('change', updateDeptSelect);
            document.getElementById('deptSelect').addEventListener('change', updateProductSelect);
            document.getElementById('storeSelectForDept').addEventListener('change', updateDeptList);
            document.getElementById('storeSelectForProducts').addEventListener('change', updateDeptSelectForProducts);
            document.getElementById('deptSelectForProducts').addEventListener('change', updateProductList);
            document.getElementById('customProduct').addEventListener('input', (e) => suggestProducts(e.target.value));
            document.getElementById('customProduct').addEventListener('keydown', handleKey);
            document.getElementById('listSelect').addEventListener('change', (e) => {
                selectedList = e.target.value;
                updateShoppingList();
                updateSelectedItemsColumn();
            });
            document.getElementById('listSelectForShop').addEventListener('change', updateShoppingList);
        });
    </script>
</body>
</html>
