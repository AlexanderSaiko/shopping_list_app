<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</title>
    <style>
        :root {
            --background: #f2f2f7;
            --card-background: #ffffff;
            --text: #000000;
            --secondary-text: #6e6e73;
            --accent: #007aff;
            --button-background: #007aff;
            --button-text: #ffffff;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --border: #d1d1d6;
            --completed: #ff0000;
        }

        [data-theme="dark"] {
            --background: #1c1c1e;
            --card-background: #2c2c2e;
            --text: #ffffff;
            --secondary-text: #8e8e93;
            --accent: #0a84ff;
            --button-background: #0a84ff;
            --button-text: #ffffff;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            --border: #3c3c3e;
            --completed: #ff6666;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', sans-serif;
            background: var(--background);
            color: var(--text);
            transition: all 0.3s ease;
        }

        header {
            background: var(--card-background);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header h1 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text);
        }

        nav {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        nav button {
            background: none;
            border: none;
            color: var(--secondary-text);
            font-size: 16px;
            padding: 8px 12px;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        nav button.active, nav button:hover {
            color: var(--accent);
        }

        .theme-toggle {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--secondary-text);
        }

        .container {
            max-width: 600px;
            margin: 16px auto;
            padding: 0 16px;
        }

        .tab {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text);
        }

        select, input[type="text"], input[type="number"], input[type="file"], input[type="password"] {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            background: var(--card-background);
            color: var(--text);
            appearance: none;
            transition: border-color 0.3s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--accent);
        }

        button {
            background: var(--button-background);
            color: var(--button-text);
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s ease;
            margin: 8px 4px;
            display: inline-block;
        }

        button:hover {
            background: var(--accent);
            filter: brightness(1.1);
        }

        button.secondary {
            background: var(--card-background);
            color: var(--accent);
            border: 1px solid var(--border);
        }

        ul {
            list-style: none;
            padding: 0;
        }

        ul li {
            background: var(--card-background);
            padding: 12px;
            margin: 8px 0;
            border-radius: 10px;
            font-size: 16px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            box-shadow: var(--shadow);
            transition: transform 0.2s ease;
        }

        ul li:hover {
            transform: translateY(-2px);
        }

        ul li.completed {
            text-decoration: line-through;
            text-decoration-color: var(--completed);
            color: var(--secondary-text);
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .quantity-controls button {
            background: var(--card-background);
            color: var(--accent);
            padding: 8px;
            font-size: 14px;
            margin: 0;
            border: 1px solid var(--border);
        }

        .quantity-controls input {
            width: 50px;
            max-width: 50px;
            text-align: center;
            margin: 0;
        }

        .comment-input, .price-input {
            flex-grow: 1;
            max-width: 200px;
        }

        #suggestions {
            position: absolute;
            background: var(--card-background);
            border: 1px solid var(--border);
            max-height: 150px;
            overflow-y: auto;
            z-index: 10;
            width: 100%;
            max-width: 300px;
            border-radius: 10px;
            box-shadow: var(--shadow);
        }

        #suggestions div {
            padding: 12px;
            cursor: pointer;
            color: var(--text);
        }

        #suggestions div:hover {
            background: var(--background);
        }

        .auth-info {
            color: var(--secondary-text);
            font-size: 14px;
            margin-left: 8px;
        }

        .list-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .list-controls select {
            max-width: 200px;
        }

        .list-controls button {
            padding: 8px 12px;
            font-size: 14px;
        }

        .edit-delete-controls {
            display: flex;
            gap: 4px;
            margin-left: auto;
        }

        .edit-delete-controls button {
            padding: 8px;
            font-size: 14px;
        }

        .total-sum {
            font-size: 18px;
            font-weight: 600;
            margin-top: 16px;
            color: var(--text);
            text-align: right;
        }

        @media (max-width: 430px) {
            header {
                flex-direction: column;
                padding: 8px;
                gap: 8px;
            }

            header h1 {
                font-size: 18px;
            }

            nav {
                justify-content: center;
                width: 100%;
                flex-wrap: wrap;
            }

            nav button {
                font-size: 14px;
                padding: 6px 8px;
            }

            .container {
                margin: 8px;
                padding: 0 8px;
            }

            h2 {
                font-size: 20px;
            }

            select, input[type="text"], input[type="number"], input[type="file"], input[type="password"] {
                max-width: 100%;
            }

            button {
                width: 100%;
                padding: 12px;
            }

            ul li {
                flex-direction: column;
                align-items: flex-start;
            }

            .quantity-controls {
                width: 100%;
                justify-content: space-between;
            }

            .comment-input, .price-input {
                max-width: 100%;
            }

            #suggestions {
                width: 100%;
            }

            .auth-info {
                margin-top: 8px;
            }

            .list-controls {
                flex-direction: column;
                align-items: flex-start;
            }

            .list-controls select {
                max-width: 100%;
            }

            .total-sum {
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</h1>
        <nav>
            <button id="shopTabBtn" class="active">–í –º–∞–≥–∞–∑–∏–Ω–µ</button>
            <button id="listsTabBtn">–°–ø–∏—Å–∫–∏</button>
            <button id="productsTabBtn">–ü—Ä–æ–¥—É–∫—Ç—ã</button>
            <button id="storesTabBtn">–ú–∞–≥–∞–∑–∏–Ω—ã</button>
            <button id="archiveTabBtn">–ê—Ä—Ö–∏–≤</button>
            <button id="authTabBtn">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</button>
            <button id="themeToggle" class="theme-toggle">üåô</button>
            <span class="auth-info" id="authInfo"></span>
        </nav>
    </header>

    <div class="container">
        <div id="shopTab" class="tab active">
            <h2>–í–∞—à–∏ –ø–æ–∫—É–ø–∫–∏</h2>
            <div class="list-controls">
                <select id="listSelectForShop">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–∏—Å–æ–∫</option>
                </select>
            </div>
            <ul id="shoppingList"></ul>
            <div class="total-sum" id="totalSum">–ò—Ç–æ–≥–æ: 0.00</div>
        </div>

        <div id="listsTab" class="tab">
            <h2>–°–ø–∏—Å–∫–∏ –ø–æ–∫—É–ø–æ–∫</h2>
            <div class="list-controls">
                <select id="listSelect">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–∏—Å–æ–∫</option>
                </select>
                <button class="secondary" id="newListBtn">–ù–æ–≤—ã–π —Å–ø–∏—Å–æ–∫</button>
                <button class="secondary" id="downloadListBtn">–°–∫–∞—á–∞—Ç—å —Å–ø–∏—Å–æ–∫</button>
                <button class="secondary" id="loadListBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                <input type="file" id="loadFile" style="display: none;" accept=".json">
            </div>
            <ul id="listManagement"></ul>
            <select id="storeSelect">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω</option>
            </select>
            <select id="deptSelect">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª</option>
            </select>
            <select id="productSelect">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç</option>
            </select>
            <button id="addItemFromSelectBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
            <input type="text" id="customProduct" placeholder="–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π –ø—Ä–æ–¥—É–∫—Ç">
            <div id="suggestions"></div>
            <button id="addItemFromInputBtn">–î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–π</button>
            <button id="saveAndSortBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <ul id="shoppingList"></ul>
        </div>

        <div id="productsTab" class="tab">
            <h2>–ü—Ä–æ–¥—É–∫—Ç—ã</h2>
            <select id="storeSelectForProducts">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω</option>
            </select>
            <select id="deptSelectForProducts">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª</option>
            </select>
            <input type="text" id="productName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞">
            <div class="quantity-controls">
                <button onclick="changeProductQuantity(-1)">‚àí</button>
                <input type="number" id="productQuantity" min="1" value="1">
                <button onclick="changeProductQuantity(1)">+</button>
            </div>
            <input type="text" id="productComment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
            <button id="addProductBtn">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</button>
            <ul id="productList"></ul>
        </div>

        <div id="storesTab" class="tab">
            <h2>–ú–∞–≥–∞–∑–∏–Ω—ã</h2>
            <input type="text" id="storeName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞">
            <button id="addStoreBtn">–î–æ–±–∞–≤–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω</button>
            <ul id="storeList"></ul>
            <h2>–û—Ç–¥–µ–ª—ã</h2>
            <select id="storeSelectForDept">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω</option>
            </select>
            <input type="text" id="deptName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª–∞">
            <input type="number" id="deptOrder" placeholder="–ü–æ—Ä—è–¥–æ–∫ –æ—Ç–¥–µ–ª–∞" min="1">
            <button id="addDepartmentBtn">–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–¥–µ–ª</button>
            <ul id="deptList"></ul>
        </div>

        <div id="archiveTab" class="tab">
            <h2>–ê—Ä—Ö–∏–≤ —Å–ø–∏—Å–∫–æ–≤</h2>
            <ul id="archiveList"></ul>
        </div>

        <div id="authTab" class="tab">
            <h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
            <input type="text" id="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
            <button id="loginBtn">–í–æ–π—Ç–∏</button>
            <button class="secondary" id="registerBtn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            <button class="secondary" id="logoutBtn">–í—ã–π—Ç–∏</button>
        </div>
    </div>

    <script>
        let shoppingLists = {};
        let defaultStores = {};
        let users = {};
        let currentUser = null;
        let selectedList = null;
        let selectedStore = null;
        let selectedSuggestionIndex = -1;
        let archiveTimeouts = {};

        function initTheme() {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            document.documentElement.setAttribute('data-theme', currentTheme === 'dark' ? 'light' : 'dark');
            console.log('Theme toggled to:', document.documentElement.getAttribute('data-theme'));
        }

        function showTab(tabId, btnId) {
            console.log(`Attempting to show tab: ${tabId} with button: ${btnId}`);
            const tab = document.getElementById(tabId);
            const btn = document.getElementById(btnId);
            if (!tab || !btn) {
                console.warn(`Tab (${tabId}) or Button (${btnId}) not found`);
                return;
            }

            document.querySelectorAll('.tab.active').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('nav button.active').forEach(btn => btn.classList.remove('active'));

            tab.classList.add('active');
            btn.classList.add('active');

            if (tabId === 'storesTab') {
                updateStoreList();
            } else if (tabId === 'productsTab') {
                updateProductList();
            } else if (tabId === 'listsTab') {
                updateListManagement();
            } else if (tabId === 'archiveTab') {
                updateArchiveList();
            }
            console.log(`Tab switched to: ${tabId}`);
        }

        function loadUsers() {
            try {
                const storedUsers = localStorage.getItem('users');
                if (storedUsers) {
                    users = JSON.parse(storedUsers) || {};
                    // Backward compatibility
                    Object.values(users).forEach(user => {
                        if (!user.archive) user.archive = {};
                        Object.values(user.stores || {}).forEach(store => {
                            store.departments.forEach(dept => {
                                if (dept.products.some(p => typeof p === 'string')) {
                                    dept.products = dept.products.map(p => typeof p === 'string' ? { name: p, quantity: 1, comment: '' } : p);
                                }
                            });
                        });
                        // Remove image fields from existing lists
                        Object.values(user.lists || {}).forEach(list => {
                            list.items.forEach(item => {
                                if (item.image) delete item.image;
                            });
                        });
                        Object.values(user.archive || {}).forEach(list => {
                            list.items.forEach(item => {
                                if (item.image) delete item.image;
                            });
                        });
                    });
                }
            } catch (e) {
                console.error('Error parsing users from localStorage:', e);
                users = {};
            }
        }

        function saveUsers() {
            try {
                localStorage.setItem('users', JSON.stringify(users));
            } catch (e) {
                console.error('Error saving users to localStorage:', e);
            }
        }

        function register() {
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            if (!usernameInput || !passwordInput) return;

            const username = usernameInput.value;
            const password = passwordInput.value;

            if (!username || !password) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å!');
                return;
            }

            if (users[username]) {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
                return;
            }

            users[username] = { password, lists: {}, stores: {}, archive: {} };
            saveUsers();
            alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏.');
            usernameInput.value = '';
            passwordInput.value = '';
        }

        function login() {
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            if (!usernameInput || !passwordInput) return;

            const username = usernameInput.value;
            const password = passwordInput.value;

            if (!username || !password) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å!');
                return;
            }

            if (!users[username]) {
                users[username] = { password, lists: {}, stores: {}, archive: {} };
                saveUsers();
            }

            if (users[username].password === password) {
                currentUser = username;
                shoppingLists = users[username].lists || {};
                defaultStores = users[username].stores || {};
                updateAuthState();
                updateListSelect();
                updateStoreSelect();
                updateStoreList();
                updateProductList();
                updateListManagement();
                updateArchiveList();
                alert('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!');
            } else {
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
            }
        }

        function logout() {
            currentUser = null;
            shoppingLists = {};
            defaultStores = {};
            selectedList = null;
            selectedStore = null;
            Object.keys(archiveTimeouts).forEach(list => clearTimeout(archiveTimeouts[list]));
            archiveTimeouts = {};
            updateAuthState();
            updateListSelect();
            updateStoreSelect();
            updateShoppingList();
            updateStoreList();
            updateProductList();
            updateListManagement();
            updateArchiveList();
        }

        function updateAuthState() {
            const authInfo = document.getElementById('authInfo');
            if (authInfo) {
                authInfo.textContent = currentUser ? `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${currentUser}` : '';
            }
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            if (usernameInput) usernameInput.value = '';
            if (passwordInput) passwordInput.value = '';
        }

        function saveShoppingLists() {
            if (currentUser && users[currentUser]) {
                users[currentUser].lists = shoppingLists;
                users[currentUser].stores = defaultStores;
                users[currentUser].archive = users[currentUser].archive || {};
                saveUsers();
            }
        }

        function updateListSelect() {
            const listSelect = document.getElementById('listSelect');
            const listSelectForShop = document.getElementById('listSelectForShop');
            if (!listSelect || !listSelectForShop) return;

            listSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–∏—Å–æ–∫</option>';
            listSelectForShop.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–∏—Å–æ–∫</option>';
            Object.keys(shoppingLists).forEach(list => {
                const option = document.createElement('option');
                option.value = list;
                option.textContent = list;
                listSelect.appendChild(option);
                listSelectForShop.appendChild(option.cloneNode(true));
            });
        }

        function updateListManagement() {
            const listManagement = document.getElementById('listManagement');
            if (!listManagement) return;

            listManagement.innerHTML = '';
            Object.keys(shoppingLists).forEach(list => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${list}</span>
                    <div class="edit-delete-controls">
                        <button onclick="editList('${list}')">‚úèÔ∏è</button>
                        <button onclick="deleteList('${list}')">üóëÔ∏è</button>
                    </div>
                `;
                listManagement.appendChild(li);
            });
        }

        function editList(oldName) {
            const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞:', oldName);
            if (newName && newName !== oldName && !shoppingLists[newName]) {
                shoppingLists[newName] = shoppingLists[oldName];
                delete shoppingLists[oldName];
                if (selectedList === oldName) selectedList = newName;
                if (archiveTimeouts[oldName]) {
                    clearTimeout(archiveTimeouts[oldName]);
                    delete archiveTimeouts[oldName];
                }
                saveShoppingLists();
                updateListSelect();
                updateListManagement();
            } else if (shoppingLists[newName]) {
                alert('–°–ø–∏—Å–æ–∫ —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
            }
        }

        function deleteList(listName) {
            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–ø–∏—Å–æ–∫ "${listName}"?`)) {
                delete shoppingLists[listName];
                if (selectedList === listName) selectedList = null;
                if (archiveTimeouts[listName]) {
                    clearTimeout(archiveTimeouts[listName]);
                    delete archiveTimeouts[listName];
                }
                saveShoppingLists();
                updateListSelect();
                updateListManagement();
                updateShoppingList();
            }
        }

        function archiveList(listName) {
            if (!shoppingLists[listName] || !currentUser) return;
            users[currentUser].archive = users[currentUser].archive || {};
            users[currentUser].archive[listName] = {
                name: listName,
                store: shoppingLists[listName].store,
                items: shoppingLists[listName].items,
                archivedAt: new Date().toISOString()
            };
            delete shoppingLists[listName];
            if (selectedList === listName) selectedList = null;
            delete archiveTimeouts[listName];
            saveShoppingLists();
            updateListSelect();
            updateListManagement();
            updateShoppingList();
            updateArchiveList();
        }

        function updateArchiveList() {
            const archiveList = document.getElementById('archiveList');
            if (!archiveList || !currentUser) return;

            archiveList.innerHTML = '';
            const archive = users[currentUser]?.archive || {};
            Object.values(archive).forEach(list => {
                const li = document.createElement('li');
                let itemsHtml = '<ul>';
                list.items.forEach(item => {
                    itemsHtml += `
                        <li class="completed">
                            ${item.dept ? `${item.name} (${item.dept.name})` : item.name}
                            (–ö–æ–ª-–≤–æ: ${item.quantity}, –¶–µ–Ω–∞: ${item.price > 0 ? item.price : '-'}, –ö–æ–º–º–µ–Ω—Ç: ${item.comment || '-'})
                        </li>
                    `;
                });
                itemsHtml += '</ul>';
                li.innerHTML = `
                    <span>${list.name} (–ú–∞–≥–∞–∑–∏–Ω: ${list.store || '-'}, –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–æ: ${new Date(list.archivedAt).toLocaleString()})</span>
                    ${itemsHtml}
                `;
                archiveList.appendChild(li);
            });
        }

        function updateStoreSelect() {
            const storeSelect = document.getElementById('storeSelect');
            const storeSelectForDept = document.getElementById('storeSelectForDept');
            const storeSelectForProducts = document.getElementById('storeSelectForProducts');
            if (!storeSelect || !storeSelectForDept || !storeSelectForProducts) return;

            storeSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω</option>';
            storeSelectForDept.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω</option>';
            storeSelectForProducts.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω</option>';
            Object.keys(defaultStores).forEach(store => {
                const option = document.createElement('option');
                option.value = store;
                option.textContent = store;
                storeSelect.appendChild(option);
                storeSelectForDept.appendChild(option.cloneNode(true));
                storeSelectForProducts.appendChild(option.cloneNode(true));
            });
            updateDeptSelect();
            updateDeptSelectForProducts();
        }

        function updateDeptSelect() {
            const storeSelect = document.getElementById('storeSelect');
            const deptSelect = document.getElementById('deptSelect');
            if (!storeSelect || !deptSelect) return;

            const storeName = storeSelect.value;
            deptSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª</option>';
            if (storeName && defaultStores[storeName]) {
                defaultStores[storeName].departments.sort((a, b) => a.order - b.order).forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.name;
                    option.textContent = dept.name;
                    deptSelect.appendChild(option);
                });
            }
            updateProductSelect();
        }

        function updateDeptSelectForProducts() {
            const storeSelect = document.getElementById('storeSelectForProducts');
            const deptSelect = document.getElementById('deptSelectForProducts');
            if (!storeSelect || !deptSelect) return;

            const storeName = storeSelect.value;
            deptSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª</option>';
            if (storeName && defaultStores[storeName]) {
                defaultStores[storeName].departments.sort((a, b) => a.order - b.order).forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.name;
                    option.textContent = dept.name;
                    deptSelect.appendChild(option);
                });
            }
            updateProductList();
        }

        function updateProductSelect() {
            const storeSelect = document.getElementById('storeSelect');
            const deptSelect = document.getElementById('deptSelect');
            const productSelect = document.getElementById('productSelect');
            if (!storeSelect || !deptSelect || !productSelect) return;

            const storeName = storeSelect.value;
            const deptName = deptSelect.value;
            productSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç</option>';
            if (storeName && deptName && defaultStores[storeName]) {
                const dept = defaultStores[storeName].departments.find(d => d.name === deptName);
                if (dept) {
                    dept.products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.name;
                        option.textContent = `${product.name} (–ö–æ–ª-–≤–æ: ${product.quantity}, –ö–æ–º–º–µ–Ω—Ç: ${product.comment || '-'})`;
                        productSelect.appendChild(option);
                    });
                }
            }
        }

        function createNewList() {
            let listName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞:', `–°–ø–∏—Å–æ–∫ ${Object.keys(shoppingLists).length + 1}`);
            if (listName && !shoppingLists[listName]) {
                shoppingLists[listName] = { store: '', items: [] };
                selectedList = listName;
                saveShoppingLists();
                updateListSelect();
                updateListManagement();
                updateShoppingList();
            } else if (shoppingLists[listName]) {
                alert('–°–ø–∏—Å–æ–∫ —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
            }
        }

        function addStore() {
            const storeNameInput = document.getElementById('storeName');
            if (!storeNameInput) return;

            const storeName = storeNameInput.value;
            if (storeName && !defaultStores[storeName]) {
                defaultStores[storeName] = { departments: [] };
                saveShoppingLists();
                updateStoreSelect();
                updateStoreList();
                storeNameInput.value = '';
            } else if (defaultStores[storeName]) {
                alert('–ú–∞–≥–∞–∑–∏–Ω —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
            }
        }

        function editStore(oldName) {
            const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞:', oldName);
            if (newName && newName !== oldName && !defaultStores[newName]) {
                defaultStores[newName] = defaultStores[oldName];
                delete defaultStores[oldName];
                Object.values(shoppingLists).forEach(list => {
                    if (list.store === oldName) list.store = newName;
                });
                if (users[currentUser]?.archive) {
                    Object.values(users[currentUser].archive).forEach(list => {
                        if (list.store === oldName) list.store = newName;
                    });
                }
                saveShoppingLists();
                updateStoreSelect();
                updateStoreList();
            } else if (defaultStores[newName]) {
                alert('–ú–∞–≥–∞–∑–∏–Ω —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
            }
        }

        function deleteStore(storeName) {
            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω "${storeName}"?`)) {
                delete defaultStores[storeName];
                Object.values(shoppingLists).forEach(list => {
                    if (list.store === storeName) list.store = '';
                });
                if (users[currentUser]?.archive) {
                    Object.values(users[currentUser].archive).forEach(list => {
                        if (list.store === storeName) list.store = '';
                    });
                }
                saveShoppingLists();
                updateStoreSelect();
                updateStoreList();
            }
        }

        function addDepartment() {
            const storeSelectForDept = document.getElementById('storeSelectForDept');
            const deptNameInput = document.getElementById('deptName');
            const deptOrderInput = document.getElementById('deptOrder');
            if (!storeSelectForDept || !deptNameInput || !deptOrderInput) return;

            const storeName = storeSelectForDept.value;
            const deptName = deptNameInput.value;
            const deptOrder = parseInt(deptOrderInput.value) || 1;
            if (storeName && deptName && defaultStores[storeName]) {
                const existingDept = defaultStores[storeName].departments.find(d => d.name === deptName);
                if (!existingDept) {
                    defaultStores[storeName].departments.push({
                        name: deptName,
                        order: deptOrder,
                        products: []
                    });
                    saveShoppingLists();
                    updateDeptList();
                    deptNameInput.value = '';
                    deptOrderInput.value = '';
                } else {
                    alert('–û—Ç–¥–µ–ª —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
                }
            } else {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω –∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª–∞!');
            }
        }

        function editDepartment(storeName, oldDeptName) {
            const newDeptName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª–∞:', oldDeptName);
            const newOrder = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–æ—Ä—è–¥–æ–∫ –æ—Ç–¥–µ–ª–∞:', defaultStores[storeName].departments.find(d => d.name === oldDeptName).order);
            if (newDeptName && newDeptName !== oldDeptName && !defaultStores[storeName].departments.find(d => d.name === newDeptName)) {
                const dept = defaultStores[storeName].departments.find(d => d.name === oldDeptName);
                dept.name = newDeptName;
                dept.order = parseInt(newOrder) || dept.order;
                Object.values(shoppingLists).forEach(list => {
                    list.items.forEach(item => {
                        if (item.dept?.name === oldDeptName) item.dept.name = newDeptName;
                    });
                });
                if (users[currentUser]?.archive) {
                    Object.values(users[currentUser].archive).forEach(list => {
                        list.items.forEach(item => {
                            if (item.dept?.name === oldDeptName) item.dept.name = newDeptName;
                        });
                    });
                }
                saveShoppingLists();
                updateDeptList();
            } else if (defaultStores[storeName].departments.find(d => d.name === newDeptName)) {
                alert('–û—Ç–¥–µ–ª —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
            }
        }

        function deleteDepartment(storeName, deptName) {
            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –æ—Ç–¥–µ–ª "${deptName}"?`)) {
                defaultStores[storeName].departments = defaultStores[storeName].departments.filter(d => d.name !== deptName);
                Object.values(shoppingLists).forEach(list => {
                    list.items.forEach(item => {
                        if (item.dept?.name === deptName) item.dept = null;
                    });
                });
                if (users[currentUser]?.archive) {
                    Object.values(users[currentUser].archive).forEach(list => {
                        list.items.forEach(item => {
                            if (item.dept?.name === deptName) item.dept = null;
                        });
                    });
                }
                saveShoppingLists();
                updateDeptList();
            }
        }

        function updateStoreList() {
            const storeList = document.getElementById('storeList');
            if (!storeList) return;

            storeList.innerHTML = '';
            Object.keys(defaultStores).forEach(store => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${store}</span>
                    <div class="edit-delete-controls">
                        <button onclick="editStore('${store}')">‚úèÔ∏è</button>
                        <button onclick="deleteStore('${store}')">üóëÔ∏è</button>
                    </div>
                `;
                storeList.appendChild(li);
            });
            updateDeptList();
        }

        function updateDeptList() {
            const storeSelectForDept = document.getElementById('storeSelectForDept');
            const deptList = document.getElementById('deptList');
            if (!storeSelectForDept || !deptList) return;

            const storeName = storeSelectForDept.value;
            deptList.innerHTML = '';
            if (storeName && defaultStores[storeName]) {
                defaultStores[storeName].departments.sort((a, b) => a.order - b.order).forEach(dept => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>${dept.name} (–ü–æ—Ä—è–¥–æ–∫: ${dept.order})</span>
                        <div class="edit-delete-controls">
                            <button onclick="editDepartment('${storeName}', '${dept.name}')">‚úèÔ∏è</button>
                            <button onclick="deleteDepartment('${storeName}', '${dept.name}')">üóëÔ∏è</button>
                        </div>
                    `;
                    deptList.appendChild(li);
                });
            }
        }

        function changeProductQuantity(delta) {
            const quantityInput = document.getElementById('productQuantity');
            if (quantityInput) {
                quantityInput.value = Math.max(1, parseInt(quantityInput.value) + delta);
            }
        }

        function addProduct() {
            const storeSelect = document.getElementById('storeSelectForProducts');
            const deptSelect = document.getElementById('deptSelectForProducts');
            const productNameInput = document.getElementById('productName');
            const quantityInput = document.getElementById('productQuantity');
            const commentInput = document.getElementById('productComment');
            if (!storeSelect || !deptSelect || !productNameInput || !quantityInput || !commentInput) return;

            const storeName = storeSelect.value;
            const deptName = deptSelect.value;
            const productName = productNameInput.value;
            const quantity = parseInt(quantityInput.value) || 1;
            const comment = commentInput.value;

            if (!storeName || !deptName || !productName) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω, –æ—Ç–¥–µ–ª –∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞!');
                return;
            }

            const dept = defaultStores[storeName].departments.find(d => d.name === deptName);
            if (dept) {
                if (!dept.products.find(p => p.name === productName)) {
                    dept.products.push({ name: productName, quantity, comment });
                    saveShoppingLists();
                    updateProductList();
                    updateProductSelect();
                    productNameInput.value = '';
                    quantityInput.value = '1';
                    commentInput.value = '';
                } else {
                    alert('–ü—Ä–æ–¥—É–∫—Ç —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —ç—Ç–æ–º –æ—Ç–¥–µ–ª–µ!');
                }
            }
        }

        function updateProductList() {
            const storeSelect = document.getElementById('storeSelectForProducts');
            const deptSelect = document.getElementById('deptSelectForProducts');
            const productList = document.getElementById('productList');
            if (!storeSelect || !deptSelect || !productList) return;

            const storeName = storeSelect.value;
            const deptName = deptSelect.value;
            productList.innerHTML = '';
            if (storeName && deptName && defaultStores[storeName]) {
                const dept = defaultStores[storeName].departments.find(d => d.name === deptName);
                if (dept) {
                    dept.products.forEach(product => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <span>${product.name} (–ö–æ–ª-–≤–æ: ${product.quantity}, –ö–æ–º–º–µ–Ω—Ç: ${product.comment || '-'})</span>
                            <div class="edit-delete-controls">
                                <button onclick="editProduct('${storeName}', '${deptName}', '${product.name}')">‚úèÔ∏è</button>
                                <button onclick="deleteProduct('${storeName}', '${deptName}', '${product.name}')">üóëÔ∏è</button>
                            </div>
                        `;
                        productList.appendChild(li);
                    });
                }
            }
        }

        function editProduct(storeName, deptName, oldProductName) {
            const dept = defaultStores[storeName].departments.find(d => d.name === deptName);
            if (!dept) return;

            const product = dept.products.find(p => p.name === oldProductName);
            const newProductName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞:', oldProductName);
            const newQuantity = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:', product.quantity);
            const newComment = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:', product.comment || '');

            if (newProductName && newProductName !== oldProductName && !dept.products.find(p => p.name === newProductName)) {
                product.name = newProductName;
                product.quantity = parseInt(newQuantity) || product.quantity;
                product.comment = newComment;
                Object.values(shoppingLists).forEach(list => {
                    list.items.forEach(item => {
                        if (item.name === oldProductName && item.dept?.name === deptName) {
                            item.name = newProductName;
                        }
                    });
                });
                if (users[currentUser]?.archive) {
                    Object.values(users[currentUser].archive).forEach(list => {
                        list.items.forEach(item => {
                            if (item.name === oldProductName && item.dept?.name === deptName) {
                                item.name = newProductName;
                            }
                        });
                    });
                }
                saveShoppingLists();
                updateProductList();
                updateProductSelect();
            } else if (dept.products.find(p => p.name === newProductName)) {
                alert('–ü—Ä–æ–¥—É–∫—Ç —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
            }
        }

        function deleteProduct(storeName, deptName, productName) {
            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç "${productName}"?`)) {
                const dept = defaultStores[storeName].departments.find(d => d.name === deptName);
                if (dept) {
                    dept.products = dept.products.filter(p => p.name !== productName);
                    Object.values(shoppingLists).forEach(list => {
                        list.items = list.items.filter(item => !(item.name === productName && item.dept?.name === deptName));
                    });
                    if (users[currentUser]?.archive) {
                        Object.values(users[currentUser].archive).forEach(list => {
                            list.items = list.items.filter(item => !(item.name === productName && item.dept?.name === deptName));
                        });
                    }
                    saveShoppingLists();
                    updateProductList();
                    updateProductSelect();
                }
            }
        }

        function suggestProducts(input) {
            const suggestions = document.getElementById('suggestions');
            if (!suggestions) return;

            suggestions.innerHTML = '';
            selectedSuggestionIndex = -1;
            if (input && selectedStore && defaultStores[selectedStore]) {
                const matches = defaultStores[selectedStore].departments.flatMap(dept =>
                    dept.products.filter(p => p.name.toLowerCase().includes(input.toLowerCase())).map(p => ({ product: p, dept }))
                );
                matches.forEach(({ product, dept }) => {
                    const div = document.createElement('div');
                    div.textContent = `${product.name} (${dept.name})`;
                    div.onclick = () => {
                        const customProductInput = document.getElementById('customProduct');
                        if (customProductInput) {
                            customProductInput.value = product.name;
                            suggestions.innerHTML = '';
                            addItemFromInput();
                        }
                    };
                    suggestions.appendChild(div);
                });
            }
        }

        function handleKey(event) {
            const suggestions = document.getElementById('suggestions')?.children;
            if (!suggestions || suggestions.length === 0) return;

            if (event.key === 'ArrowDown') {
                selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestions.length - 1);
                updateSuggestionHighlight();
            } else if (event.key === 'ArrowUp') {
                selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                updateSuggestionHighlight();
            } else if (event.key === 'Enter' && selectedSuggestionIndex >= 0) {
                const customProductInput = document.getElementById('customProduct');
                if (customProductInput) {
                    customProductInput.value = suggestions[selectedSuggestionIndex].textContent;
                    document.getElementById('suggestions').innerHTML = '';
                    addItemFromInput();
                    event.preventDefault();
                }
            }
        }

        function updateSuggestionHighlight() {
            const suggestions = document.getElementById('suggestions')?.children;
            if (!suggestions) return;

            for (let i = 0; i < suggestions.length; i++) {
                suggestions[i].style.background = i === selectedSuggestionIndex ? 'var(--background)' : 'var(--card-background)';
            }
        }

        function findDepartment(productName) {
            if (selectedStore && defaultStores[selectedStore]) {
                return defaultStores[selectedStore].departments.find(dept => dept.products.some(p => p.name === productName));
            }
            return null;
        }

        function ensureSelectedList() {
            if (!selectedList || !shoppingLists[selectedList]) {
                const listNames = Object.keys(shoppingLists);
                if (listNames.length > 0) {
                    selectedList = listNames[0];
                } else {
                    let newListName = `–°–ø–∏—Å–æ–∫ ${listNames.length + 1}`;
                    shoppingLists[newListName] = { store: '', items: [] };
                    selectedList = newListName;
                    saveShoppingLists();
                    updateListSelect();
                    updateListManagement();
                }
            }
            return selectedList;
        }

        function addItemFromSelect() {
            const storeSelect = document.getElementById('storeSelect');
            const deptSelect = document.getElementById('deptSelect');
            const productSelect = document.getElementById('productSelect');
            if (!storeSelect || !deptSelect || !productSelect) return;

            const storeName = storeSelect.value;
            const deptName = deptSelect.value;
            const productName = productSelect.value;

            console.log('Adding item from select:', { storeName, deptName, productName, selectedList });

            if (!storeName) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω!');
                return;
            }

            if (productName && deptName) {
                selectedStore = storeName;
                ensureSelectedList();
                shoppingLists[selectedList].store = storeName;
                const dept = defaultStores[storeName].departments.find(d => d.name === deptName);
                const product = dept.products.find(p => p.name === productName);
                shoppingLists[selectedList].items.push({
                    name: productName,
                    dept: dept ? { name: dept.name, order: dept.order } : null,
                    isCustom: false,
                    quantity: product.quantity,
                    comment: product.comment || '',
                    price: 0,
                    completed: false
                });
                saveShoppingLists();
                productSelect.value = '';
                updateShoppingList();
            } else {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª –∏ –ø—Ä–æ–¥—É–∫—Ç!');
            }
        }

        function addItemFromInput() {
            const storeSelect = document.getElementById('storeSelect');
            const customProductInput = document.getElementById('customProduct');
            if (!storeSelect || !customProductInput) return;

            const storeName = storeSelect.value;
            const customProduct = customProductInput.value;

            console.log('Adding item from input:', { storeName, customProduct, selectedList });

            if (!storeName) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω!');
                return;
            }

            if (customProduct) {
                selectedStore = storeName;
                ensureSelectedList();
                shoppingLists[selectedList].store = storeName;
                const existingDept = findDepartment(customProduct);
                shoppingLists[selectedList].items.push({
                    name: customProduct,
                    dept: existingDept ? { name: existingDept.name, order: existingDept.order } : null,
                    isCustom: !existingDept,
                    quantity: 1,
                    comment: '',
                    price: 0,
                    completed: false
                });
                saveShoppingLists();
                customProductInput.value = '';
                document.getElementById('suggestions').innerHTML = '';
                updateShoppingList();
            } else {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞!');
            }
        }

        function saveAndSort() {
            if (!selectedList || !selectedStore) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –∏ –º–∞–≥–∞–∑–∏–Ω!');
                return;
            }
            shoppingLists[selectedList].items.sort((a, b) => {
                if (a.isCustom && !b.isCustom) return 1;
                if (!a.isCustom && b.isCustom) return -1;
                return (a.dept ? a.dept.order : Infinity) - (b.dept ? b.dept.order : Infinity);
            });
            saveShoppingLists();
            updateShoppingList();
        }

        function calculateTotalSum(listName) {
            if (!listName || !shoppingLists[listName]) return 0;
            return shoppingLists[listName].items.reduce((sum, item) => {
                const price = parseFloat(item.price) || 0;
                return sum + (item.quantity * price);
            }, 0).toFixed(2);
        }

        function checkAndScheduleArchive(listName) {
            if (!shoppingLists[listName] || archiveTimeouts[listName]) return;
            const allCompleted = shoppingLists[listName].items.every(item => item.completed);
            if (allCompleted && shoppingLists[listName].items.length > 0) {
                archiveTimeouts[listName] = setTimeout(() => {
                    archiveList(listName);
                }, 10 * 60 * 1000); // 10 minutes
            }
        }

        function updateShoppingList() {
            const list = document.getElementById('shoppingList');
            const totalSum = document.getElementById('totalSum');
            if (!list || !totalSum) return;

            list.innerHTML = '';
            const listSelectForShop = document.getElementById('listSelectForShop');
            if (!listSelectForShop) return;

            const selectedListForShop = listSelectForShop.value || selectedList;
            if (selectedListForShop && shoppingLists[selectedListForShop]) {
                selectedStore = shoppingLists[selectedListForShop].store;
                shoppingLists[selectedListForShop].items.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>${item.dept ? `${item.name} (${item.dept.name})` : item.name}</span>
                        <div class="quantity-controls">
                            <button onclick="changeQuantity('${selectedListForShop}', ${index}, -1)">‚àí</button>
                            <input type="number" min="1" value="${item.quantity}" onchange="updateQuantity('${selectedListForShop}', ${index}, this.value)">
                            <button onclick="changeQuantity('${selectedListForShop}', ${index}, 1)">+</button>
                        </div>
                        <input type="text" class="comment-input" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" value="${item.comment || ''}" oninput="updateComment('${selectedListForShop}', ${index}, this.value)">
                        <input type="number" class="price-input" placeholder="–¶–µ–Ω–∞" step="0.01" min="0" value="${item.price > 0 ? item.price : ''}" oninput="updatePrice('${selectedListForShop}', ${index}, this.value)">
                    `;
                    li.onclick = (e) => {
                        if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') {
                            item.completed = !item.completed;
                            li.classList.toggle('completed', item.completed);
                            saveShoppingLists();
                            totalSum.textContent = `–ò—Ç–æ–≥–æ: ${calculateTotalSum(selectedListForShop)}`;
                            checkAndScheduleArchive(selectedListForShop);
                        }
                    };
                    if (item.completed) li.classList.add('completed');
                    list.appendChild(li);
                });
                totalSum.textContent = `–ò—Ç–æ–≥–æ: ${calculateTotalSum(selectedListForShop)}`;
                checkAndScheduleArchive(selectedListForShop);
            } else {
                totalSum.textContent = `–ò—Ç–æ–≥–æ: 0.00`;
            }
        }

        function changeQuantity(listName, index, delta) {
            if (listName && shoppingLists[listName]) {
                shoppingLists[listName].items[index].quantity = Math.max(1, shoppingLists[listName].items[index].quantity + delta);
                saveShoppingLists();
                updateShoppingList();
            }
        }

        function updateQuantity(listName, index, value) {
            if (listName && shoppingLists[listName]) {
                shoppingLists[listName].items[index].quantity = Math.max(1, parseInt(value) || 1);
                saveShoppingLists();
                updateShoppingList();
            }
        }

        function updateComment(listName, index, value) {
            if (listName && shoppingLists[listName]) {
                shoppingLists[listName].items[index].comment = value;
                saveShoppingLists();
            }
        }

        function updatePrice(listName, index, value) {
            if (listName && shoppingLists[listName]) {
                shoppingLists[listName].items[index].price = parseFloat(value) || 0;
                saveShoppingLists();
                const totalSum = document.getElementById('totalSum');
                if (totalSum) {
                    totalSum.textContent = `–ò—Ç–æ–≥–æ: ${calculateTotalSum(listName)}`;
                }
            }
        }

        function downloadList() {
            if (selectedList && shoppingLists[selectedList]) {
                const json = JSON.stringify(shoppingLists[selectedList].items, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${selectedList}_${shoppingLists[selectedList].store}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } else {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è!');
            }
        }

        function loadListFromFile() {
            const storeSelect = document.getElementById('storeSelect');
            const fileInput = document.getElementById('loadFile');
            if (!storeSelect || !fileInput) return;

            const storeName = storeSelect.value;
            if (!storeName) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω!');
                return;
            }

            const file = fileInput.files[0];
            if (file) {
                selectedStore = storeName;
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const loadedList = JSON.parse(event.target.result);
                        if (Array.isArray(loadedList)) {
                            let listName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –∑–∞–≥—Ä—É–∂–∞–µ–º–æ–≥–æ —Å–ø–∏—Å–∫–∞:', `–°–ø–∏—Å–æ–∫ ${Object.keys(shoppingLists).length + 1}`);
                            if (!listName) return;
                            if (shoppingLists[listName]) {
                                alert('–°–ø–∏—Å–æ–∫ —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
                                return;
                            }
                            shoppingLists[listName] = {
                                store: storeName,
                                items: loadedList.map(item => ({
                                    name: item.name,
                                    dept: defaultStores[storeName].departments.find(d => d.name === (item.dept?.name || '')) || null,
                                    isCustom: item.isCustom || false,
                                    quantity: item.quantity || 1,
                                    comment: item.comment || '',
                                    price: item.price || 0,
                                    completed: item.completed || false
                                }))
                            };
                            selectedList = listName;
                            saveShoppingLists();
                            updateListSelect();
                            updateListManagement();
                            updateShoppingList();
                            alert('–°–ø–∏—Å–æ–∫ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!');
                        } else {
                            alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞!');
                        }
                    } catch (e) {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞: ' + e.message);
                    }
                };
                reader.readAsText(file);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded, initializing...');
            initTheme();
            loadUsers();
            updateAuthState();

            // Event listeners for navigation buttons
            const shopTabBtn = document.getElementById('shopTabBtn');
            const listsTabBtn = document.getElementById('listsTabBtn');
            const productsTabBtn = document.getElementById('productsTabBtn');
            const storesTabBtn = document.getElementById('storesTabBtn');
            const archiveTabBtn = document.getElementById('archiveTabBtn');
            const authTabBtn = document.getElementById('authTabBtn');
            const themeToggle = document.getElementById('themeToggle');

            if (shopTabBtn) {
                shopTabBtn.onclick = () => {
                    console.log('Shop tab button clicked');
                    showTab('shopTab', 'shopTabBtn');
                };
                console.log('Shop tab button listener attached');
            } else {
                console.warn('Shop tab button not found');
            }

            if (listsTabBtn) {
                listsTabBtn.onclick = () => {
                    console.log('Lists tab button clicked');
                    showTab('listsTab', 'listsTabBtn');
                };
                console.log('Lists tab button listener attached');
            } else {
                console.warn('Lists tab button not found');
            }

            if (productsTabBtn) {
                productsTabBtn.onclick = () => {
                    console.log('Products tab button clicked');
                    showTab('productsTab', 'productsTabBtn');
                };
                console.log('Products tab button listener attached');
            } else {
                console.warn('Products tab button not found');
            }

            if (storesTabBtn) {
                storesTabBtn.onclick = () => {
                    console.log('Stores tab button clicked');
                    showTab('storesTab', 'storesTabBtn');
                };
                console.log('Stores tab button listener attached');
            } else {
                console.warn('Stores tab button not found');
            }

            if (archiveTabBtn) {
                archiveTabBtn.onclick = () => {
                    console.log('Archive tab button clicked');
                    showTab('archiveTab', 'archiveTabBtn');
                };
                console.log('Archive tab button listener attached');
            } else {
                console.warn('Archive tab button not found');
            }

            if (authTabBtn) {
                authTabBtn.onclick = () => {
                    console.log('Auth tab button clicked');
                    showTab('authTab', 'authTabBtn');
                };
                console.log('Auth tab button listener attached');
            } else {
                console.warn('Auth tab button not found');
            }

            if (themeToggle) {
                themeToggle.onclick = () => {
                    console.log('Theme toggle button clicked');
                    toggleTheme();
                };
                console.log('Theme toggle button listener attached');
            } else {
                console.warn('Theme toggle button not found');
            }

            // Other event listeners
            const listSelectForShop = document.getElementById('listSelectForShop');
            const listSelect = document.getElementById('listSelect');
            const storeSelect = document.getElementById('storeSelect');
            const deptSelect = document.getElementById('deptSelect');
            const storeSelectForProducts = document.getElementById('storeSelectForProducts');
            const deptSelectForProducts = document.getElementById('deptSelectForProducts');
            const newListBtn = document.getElementById('newListBtn');
            const downloadListBtn = document.getElementById('downloadListBtn');
            const loadListBtn = document.getElementById('loadListBtn');
            const addItemFromSelectBtn = document.getElementById('addItemFromSelectBtn');
            const addItemFromInputBtn = document.getElementById('addItemFromInputBtn');
            const saveAndSortBtn = document.getElementById('saveAndSortBtn');
            const addStoreBtn = document.getElementById('addStoreBtn');
            const addDepartmentBtn = document.getElementById('addDepartmentBtn');
            const addProductBtn = document.getElementById('addProductBtn');
            const loginBtn = document.getElementById('loginBtn');
            const registerBtn = document.getElementById('registerBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const customProductInput = document.getElementById('customProduct');
            const loadFileInput = document.getElementById('loadFile');

            if (listSelectForShop) listSelectForShop.onchange = updateShoppingList;
            if (listSelect) listSelect.onchange = () => { selectedList = listSelect.value; updateShoppingList(); };
            if (storeSelect) storeSelect.onchange = updateDeptSelect;
            if (deptSelect) deptSelect.onchange = updateProductSelect;
            if (storeSelectForProducts) storeSelectForProducts.onchange = updateDeptSelectForProducts;
            if (deptSelectForProducts) deptSelectForProducts.onchange = updateProductList;
            if (newListBtn) newListBtn.onclick = createNewList;
            if (downloadListBtn) downloadListBtn.onclick = downloadList;
            if (loadListBtn) loadListBtn.onclick = () => loadFileInput?.click();
            if (addItemFromSelectBtn) addItemFromSelectBtn.onclick = addItemFromSelect;
            if (addItemFromInputBtn) addItemFromInputBtn.onclick = addItemFromInput;
            if (saveAndSortBtn) saveAndSortBtn.onclick = saveAndSort;
            if (addStoreBtn) addStoreBtn.onclick = addStore;
            if (addDepartmentBtn) addDepartmentBtn.onclick = addDepartment;
            if (addProductBtn) addProductBtn.onclick = addProduct;
            if (loginBtn) loginBtn.onclick = login;
            if (registerBtn) registerBtn.onclick = register;
            if (logoutBtn) logoutBtn.onclick = logout;
            if (customProductInput) {
                customProductInput.oninput = () => suggestProducts(customProductInput.value);
                customProductInput.onkeydown = handleKey;
            }
            if (loadFileInput) loadFileInput.onchange = loadListFromFile;

            console.log('Initialization complete');
        });
    </script>
</body>
</html>
